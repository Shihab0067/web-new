console.log("base js utils active");

const isCorporatePage = window.location.pathname.includes('/corporate');

const API_PATHS = {
    results: addSelectorForJsonServlet("news-listing"),
    hints: addSelectorForJsonServlet("hints"),
    newsletter: addSelectorForJsonServlet("newsletter"),
};

function addSelectorForJsonServlet(selector, url = location.href) {
    const urlObj = new URL(url);
    urlObj.pathname = urlObj.pathname.replace(/\/?$/, '').replace(/(\.html)?$/, '.' + selector + '.model.json');
    return urlObj.href;
}

function getGatewayPageStatus() {
    const hiddenPageProperties = document.getElementById('hiddenPageProperties');
    if (hiddenPageProperties) {
        const isGatewayPage = hiddenPageProperties.getAttribute('data-isGatewayPage');
        if (isGatewayPage === 'true') return true;
        if (isGatewayPage === 'false') return false;
        console.warn('utils.js: Valore inaspettato per isGatewayPage:', isGatewayPage);
        return false;
    }
    console.error('utils.js: Elemento hiddenPageProperties non trovato');
    return null;
}

async function fetchJSON(url, paramsObj, init = false) {
    const baseUrl = url.split('?')[0];
    const initialParams = init ? new URLSearchParams(url.split('?')[1] || '') : new URLSearchParams();
    const runtimeParams = new URLSearchParams();
    for (const key in paramsObj) {
        if (paramsObj[key] !== undefined && paramsObj[key] !== null && paramsObj[key] !== '') {
            runtimeParams.set(key, paramsObj[key]);
        }
    }
    for (const [key, value] of runtimeParams.entries()) {
        initialParams.set(key, value);
    }

    let queryString = initialParams.toString().replace(/%2C/g, ',');
    const fullUrl = baseUrl + (queryString ? '?' + queryString : '');

    const response = await fetch(fullUrl);
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    return await response.json();
}

async function fetchPostJSON(url, payload) {
    let csrf;
    let headers = {
        'Content-Type': 'application/json',
        'Accept': 'application/json'
    }

    //check if we are in author mode
    if(/\/content(\/|$)/.test(url)){
        csrf = await getCsrfToken();
        headers['CSRF-Token'] = csrf;
    }

    csrf = await getCsrfToken();
    headers['CSRF-Token'] = csrf;
    const response = await fetch(url, {
        method: 'POST',
        headers: headers,
        body: JSON.stringify(payload)
    });
    if (!response.ok) {
        const error = new Error(`HTTP error! status: ${response.status}`);
        error.response = response;
        throw error;
    }
    const contentType = response.headers.get("content-type");
    if (contentType && contentType.includes("application/json")) {
        const text = await response.text();
        if (!text) return {
            'text': 'fetchPostJSON risposta text vuota',
            'status': response.status
        }; //
        return JSON.parse(text);
    }
    return response;
}

async function getCsrfToken() {
    const meta = document.querySelector('meta[name="csrf-token"]');
    if(!meta){
        const res = await fetch('/libs/granite/csrf/token.json', {
            method: 'GET',
            credentials: 'include'
        });
        if (!res.ok) throw new Error('Failed to get CSRF token: ' + res.status);
        const json = await res.json();
        return json && json.token ? json.token : null;
    }
    return meta.getAttribute('content');
}

function createEditorialCard(data) {
    const card = document.createElement('f-card-editorial');
    card.setAttribute('label-prefix-variant', 'date');

    if (isCorporatePage) {
        card.setAttribute('label-prefix', data.labelPrefix || '');
        card.setAttribute('label', Array.isArray(data.label) ? data.label.filter(Boolean).join(', ') : '');
        card.setAttribute('maintitle', decodeHtmlEntities(data.maintitle) || '');
        card.setAttribute('variant', 'landscape');
        card.setAttribute('href', removeContentFerrariFcom(data.href) || '');
        card.setAttribute('pdf-link', data.downloadHref || '');
        card.setAttribute('link-icon', 'none');
        card.setAttribute('translated-cta-text', 'readmore');
        return card;
    }

    card.setAttribute('label-prefix', data.labelPrefix || '');
    card.setAttribute('label', Array.isArray(data.label) ? data.label.filter(Boolean).join(', ') : '');
    card.setAttribute('maintitle', decodeHtmlEntities(data.maintitle) || '');
    card.setAttribute('href', removeContentFerrariFcom(data.href) || '');
    card.setAttribute('share-url', removeContentFerrariFcom(data.href) || '');

    if (data.landscapeSrc || data.portraitSrc) {
        const img = document.createElement('f-aem-dynamic-media-image');
        img.setAttribute('slot', 'image');
        img.setAttribute('resize-id', 'card-editorial-landscape-m');
        if (data.landscapeSrc) img.setAttribute('landscape-src', data.landscapeSrc);
        if (data.portraitSrc) img.setAttribute('portrait-src', data.portraitSrc);
        card.appendChild(img);
    }

    return card;
}

function printCards(data, from, to, boxId, append = false) {
    if (!Array.isArray(data)) return console.error('utils.js: Il primo parametro deve essere un array');
    if (from < 0 || to < from) return console.error('utils.js: Indici non validi');

    const container = document.getElementById(boxId);
    if (!container) return console.warn(`utils.js: Elemento box grid ${boxId} non trovato`);

    const slotChildren = [...container.children].filter(child => child.hasAttribute('slot'));

    if (!append) {
        container.innerHTML = '';
        slotChildren.forEach(el => container.appendChild(el));
    }

    const ul = document.getElementById('ulHiddenTagSeo');
    if (ul && !append) ul.innerHTML = '';

    const items = data.slice(from, to + 1);
    items.forEach(item => {
        const card = createEditorialCard(item);
        container.appendChild(card);

        if (ul && item.href && item.maintitle) {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.href = removeContentFerrariFcom(item.href);
            a.textContent = decodeHtmlEntities(item.maintitle);
            li.appendChild(a);
            ul.appendChild(li);
        }
    });
}

function buildQueryParams({ filters = {}, skip = 0, limit = 9, exclude = '' } = {}) {
    return {
        year: filters.year || '',
        tag: filters.tag || '',
        categories: (filters.categories || []).join(','),
        limit,
        skip,
        exclude,
        excludeChannels: isCorporatePage ? undefined : 'corporate'
    };
}

function showHideFeaturedNews() {
    const featuredNews = document.getElementById("featuredNewsId");
    const fBanner = document.querySelector("f-banner");
    const url = new URL(window.location.href);
    const params = new URLSearchParams(url.search);
    const hasFilterParams =
        params.has('year') ||
        params.has('tag') ||
        params.has('categories');
    const pageNumber = newsListingHeadline?.getAttribute("page-number") || "1";
    const hideFeatured = hasFilterParams || pageNumber !== "1";
    if (featuredNews) {
        featuredNews.style.display = hideFeatured ? "none" : "block";
    }
    if (fBanner) {
        fBanner.style.display = hideFeatured ? "none" : "block";
    }
}

function showHideFeaturedNews() {
    const featuredNews = document.getElementById("featuredNewsId");
    const fBanner = document.querySelector("f-banner");
    const pageNumber = newsListingHeadline?.getAttribute("page-number") || "1";

    const hasFilters = hasActiveFilters(getNormalizedFilters(newsListingHeadline?.getCurrentFilters?.() || {}));
    const hideFeatured = hasFilters || pageNumber !== "1";

    if (featuredNews) {
        featuredNews.style.display = hideFeatured ? "none" : "block";
    }
    if (fBanner) {
        fBanner.style.display = hideFeatured ? "none" : "block";
    }
}



function decodeHtmlEntities(str) {
    if (!str || typeof str !== 'string') return '';
    const parser = new DOMParser();
    const doc = parser.parseFromString(str, 'text/html');
    return doc.documentElement.textContent || '';
}

const isPublishCached = (() => {
    const hostname = window.location.hostname;
    return hostname.includes('www.ferrari.com') || hostname.includes('gateway-new.dev.ferrari.com');
})();

function removeContentFerrariFcom(url) {
    return isPublishCached ? url.replace("/content/ferrari-fcom", "") : url;
}


function findComponentSlug(options) {
    var tagName = options.tagName;
    var idBase = options.idBase;
    var slug = options.slug;
    var selector = null;
    if (!tagName && !idBase) {
        console.warn("findElement richiede almeno tagName o idBase");
        return null;
    }
    if (idBase) {
        if (slug && slug.trim()) {
            selector = "#" + idBase + "-" + slug;
        } else {
            selector = "#" + idBase + "-" ;
        }
    } else if (tagName) {
        if (slug && slug.trim()) {
            selector = tagName + '[slug="' + slug + '"]';
        } else {
            selector = tagName;
        }
    }
    return document.querySelector(selector);
}
